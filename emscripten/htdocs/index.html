<!DOCTYPE html>
<!--
 webPSX: HTML5 Audio/JavaScript port of Highly Experimantal.

 	Copyright (C) 2015 Juergen Wothke

 Original C code of "deadbeef_he" (see https://github.com/kode54/deadbeef_he/)

	
 Terms of Use: This software is licensed under a CC BY-NC-SA 
 (http://creativecommons.org/licenses/by-nc-sa/4.0/).

 Credits: The visualization used on this page was strongly "inspired" by <a target="_blank" href="http://html5-demos.appspot.com/static/webaudio/createMediaSourceElement.html">this demo</a>

-->

<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<title>webPSX - the PSX music player for the Web</title>
<!-- emulate arrows of "HTML5 <details>" in Firefox-->
<style>			
	.no-details details > summary:before { float: left; width: 15px; content: '\25B6'; }
	.no-details details.open > summary:before { content: '\25BC'; }
</style>

<meta name="description" content="Experimental JavaScript version of Highly Experimental; it supports PlayStation formats like: psf, minipsf, psf2, minipsf2, psflib">
<meta name="author" content="Juergen Wothke">
<meta name="keywords" content="Web Audio API, HTML5, JavaScript">

<!--link href="http://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet" type="text/css"-->
<link href="font.css" rel="stylesheet" type="text/css">
<link href="common.css" rel="stylesheet" type="text/css">
<link rel="image_src" href="screenshot.gif" />
<meta property="og:image" content="http://www.wothke.ch/webpsx/screenshot.gif" />



<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link type="image/x-icon" href="favicon.ico" />

<script type="text/javascript" src="web_psx.js"></script>
<script type="text/javascript" src="sample_player.js"></script>

<script src="/webpsx/stdlib/jquery1.11.min.js"></script>
<script src="/webpsx/stdlib/jquery.details.min.js"></script>
<script>
	window.console || (window.console = { 'log': alert });
	$(function() {
		$('html').addClass($.fn.details.support ? 'details' : 'no-details');
		$('details').details();

		// initially expand details
		if ($.fn.details.support) {
			$('details').attr('open', '');	// Chrome
		} else {
			var $details= $('details');
			var $detailsSummary = $('summary', $details).first();
			var $detailsNotSummary = $details.children(':not(summary)');
			
    		$details.addClass('open').prop('open', true).triggerHandler('open.details');
    //		$detailsSummary.attr('aria-expanded', true);
    		$detailsNotSummary.show();
		}
		
		if (!window.webkitAudioContext) {
			// hack to get rid of Firefox specific pseudo elements used to sim webkit-box-reflect
			var e = document.getElementById("moz-reflect-logo");		
			e.className += " enableMozReflection";
			var e2 = document.getElementById("moz-reflect-spectrum");		
			e2.className += " enableMozReflection";
		}
	});	
</script>

<script>
var basePath= 'music/';	// configured "songs" below must use this prefix!
var songs = [	
];

var player= new SamplePlayer(basePath, doOnEnd, doOnUpdate, doOnInitialized);

function doOnEnd(){ audio.playNextSong(); player.isPaused= false; }
function doOnUpdate(){ 
	audio.initialAudioSetup();
	updateGUI();
	audio.startMusicPlayback();		
}
function doOnInitialized(){
	// BIOS successfully loaded.. close the modal dialog
	window.location.hash= '';
}

// ---------------------------- WebAudio stuff ----------------------------

Audio = function(songs) {
	this.audioCtx;
	this.bufferSource;
	this.gainNode;
	this.analyzerNode;
	
	this.current=-1;
	this.someSongs= songs;
	
	if (songs.length == 0) {
//		alert("No music files available. Please place some files in your 'music' folder and configure them in the'songs' list in index.html.");
	}
	this.isReady= false;
	
	// preload all the intrastructure files so we won't run into async load issues later
	var files = [
		// place "PSX2BIOS" file here.. if default name should to be used...
	];		
	var f= window.player['preloadFiles'].bind(window.player);
	f(files, function() {
		this.isReady= true;
		this.playNextSong();
		
	}.bind(this));
};

Audio.prototype = {
	initialAudioSetup: function() {
		if (typeof this.bufferSource != 'undefined') { 
			this.bufferSource.stop(0);
		} else {
			this.setupAudioNodes();
		}
	},
	setupAudioNodes: function() {
		if (typeof this.audioCtx == 'undefined') {
			try {
				window.AudioContext = window.AudioContext||window.webkitAudioContext;
				this.audioCtx = new AudioContext();
			} catch(e) {
				alert('Web Audio API is not supported in this browser (get Chrome 18 or Firefox 26)');
			}
			this.analyzerNode = this.audioCtx.createAnalyser();

			var scriptNode= player.createScriptProcessor(this.audioCtx);
			
			this.gainNode = this.audioCtx.createGain();
						
			scriptNode.connect(this.gainNode);
			this.gainNode.connect(this.analyzerNode);
			this.analyzerNode.connect(this.audioCtx.destination);
		}
	},
	
	removeFromPlaylist: function(songname) {
		if (this.someSongs[this.current] == songname) {
			this.someSongs.splice(this.current, 1);
			if (this.current + 1 == this.someSongs.length) this.current= 0;
		}
	},
	playNextSong: function() {
		if (this.isReady && this.someSongs.length) {	
			this.current= (++this.current >=this.someSongs.length) ? 0 : this.current;
			var someSong= this.someSongs[this.current];
			this.playSong(someSong);
		}
	},
	playPreviousSong: function() {
		if (this.isReady && this.someSongs.length) {	
			this.current= (--this.current<0) ? this.current+this.someSongs.length : this.current;
			var someSong= this.someSongs[this.current];
			this.playSong(someSong);
		}
	},
	playSong: function(someSong) {
		var arr= someSong.split(";");	
		var track= arr.length>1?parseInt(arr[1]):0;
		var fn= arr[0];
		
		if (fn.indexOf(basePath) === 0) {
			var xhr = new XMLHttpRequest();
			xhr.open("GET", fn, true);
			xhr.responseType = "arraybuffer";
			xhr.onload = function (oEvent) {		
					if(!player.playSong(fn, xhr.response, track)) {
						this.removeFromPlaylist(someSong);	// no point trying to play this again
					}		
			}.bind(this);
			xhr.send(null);
		} else {
			// drag & drop stuff will directly be fetched from cache..
			player.playSong(fn, new ArrayBuffer(0), track);
		}
	},
	startMusicPlayback: function() {
		player.isPaused= false;

		if (typeof this.bufferSource === 'undefined') {
			this.bufferSource = this.audioCtx.createBufferSource();
			if (!this.bufferSource.start) {
			  this.bufferSource.start = this.bufferSource.noteOn;
			  this.bufferSource.stop = this.bufferSource.noteOff;
			}
			this.bufferSource.start(0);		
		}
	}
};

// ---------------------    drag&drop feature -----------------------------------
function allowDrop(ev) {
    ev.preventDefault();
}

function dropFile(ev, funcName) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData("Text");
	var file = ev.dataTransfer.files[0];
	if (audio.isReady && file instanceof File) {
		file.name= basePath + file.name;	// put into the same folder as our regular files
		var f= window.player[funcName].bind(window.player);
		f(file);
	}
	return file.name;
}

function drop(ev) {
	var filename= dropFile(ev, 'playTmpFile');
	audio.someSongs.push(filename);
}
function dropbios(ev) {
	dropFile(ev, 'installBIOS');
}

// ---------------------------- some visuals ----------------------------

Graphix = function(audio) {
	this.audio= audio;
	this.freqByteData= 0;
	this.hexChars= "0123456789ABCDEF";
		
	this.WIDTH= 800;
	this.HEIGHT= 200;
	
	this.canvasSpectrum = document.getElementById('spectrumCanvas');
	this.ctxSpectrum = this.canvasSpectrum.getContext('2d');
	this.canvasSpectrum.width = this.WIDTH;

	this.mozReflectSpectrum = document.getElementById('moz-reflect-spectrum');
	this.mozReflectLogo = document.getElementById('moz-reflect-logo');
	
	var canvas2 = document.getElementById('logoCanvas');
	this.ctxLegend = canvas2.getContext('2d');	
};

Graphix.prototype = {
	reqAnimationFrame: function() {
		window.requestAnimationFrame(this.redrawSpectrum.bind(this));
	},
	redrawSpectrum: function() {
		this.reqAnimationFrame();

		if (this.freqByteData == 0)
			this.freqByteData = new Uint8Array(this.audio.analyzerNode.frequencyBinCount);	
		
		this.audio.analyzerNode.getByteFrequencyData(this.freqByteData);

		var SPACER_WIDTH = 10;
		var BAR_WIDTH = 5;
		var OFFSET = 100;
		
		var numBars = Math.round(this.WIDTH / SPACER_WIDTH);

		this.ctxSpectrum.clearRect(0, 0, this.WIDTH, this.HEIGHT);

		this.ctxSpectrum.fillStyle = '#fe5139';
		this.ctxSpectrum.lineCap = 'round';
		
		for (var i = 0; i < numBars; ++i) {
			var scale= this.freqByteData[i + OFFSET]/0xff;
			var magnitude = scale*this.HEIGHT;
			x=i/numBars*500;
			
			var cols= [0x0010ff,0x00f0ff];
			
			this.ctxSpectrum.fillStyle = this.colorGradient(cols,i/numBars);	// computationally much less expensive than previous impl with use of a scaled image
			this.ctxSpectrum.fillRect(i * SPACER_WIDTH, this.HEIGHT- magnitude, BAR_WIDTH, 50*(scale*1.4));

			// hack: make sure dumb Firefox knows that redraw is needed..
			this.mozReflectSpectrum.style.visibility = "hidden";
			this.mozReflectSpectrum.style.visibility = "visible";
		}	
	},
	text: function(ctx, text, x, y) {
		ctx.strokeText(text, x, y);
		ctx.fillText(text, x, y);
	},
	redrawSongInfo: function() {
		this.ctxLegend.clearRect(0, 0, 800, 300);
		
		this.ctxLegend.textBaseline = "middle";
		this.ctxLegend.fillStyle = '#000';
		this.ctxLegend.strokeStyle = "#FFFFFF";
		
		this.ctxLegend.font = '90px serif bold';
		
		this.text(this.ctxLegend, "webPSX", 20, 70);
		this.ctxLegend.font = '25px sans-serif';
		this.text(this.ctxLegend, "Highly Experimental music..", 20, 125);

		this.ctxLegend.fillStyle = '#888';
		this.ctxLegend.font = '25px sans-serif';

		this.ctxLegend.textBaseline = 'bottom';
		this.text(this.ctxLegend, player.title, 20, 190);
		this.text(this.ctxLegend, player.program, 20, 230);
		this.text(this.ctxLegend, "", 20, 270);
		
		// hack: make sure dumb Firefox knows that redraw is needed..
		this.mozReflectLogo.style.visibility = "hidden";
		this.mozReflectLogo.style.visibility = "visible";
		
	},
	colorGradient: function(cols, s) {
		var p= (cols.length-1)*s;
		var i= Math.floor(p);
		
		return this.fadeColor(cols[i], cols[i+1], p-i);
	},
	fadeColor: function(from, to, s) {
		var r1= (from >>16) & 0xff;
		var g1= (from >>8) & 0xff;
		var b1= from & 0xff;

		var r= Math.round(r1+(((to >>16) & 0xff)-r1)*s);
		var g= Math.round(g1+(((to >>8) & 0xff)-g1)*s);
		var b= Math.round(b1+((to & 0xff)-b1)*s);
	
		return "#" +this.hex(r>>4) +this.hex(r) +this.hex(g>>4) +this.hex(g) +this.hex(b>>4) +this.hex(b);
	},
	hex: function(n) {
		return this.hexChars.charAt(n & 0xf);
	}

};

function updateGUI() {
	gfx.reqAnimationFrame();
	gfx.redrawSongInfo();
}

function init() {
	window.location.hash= 'openModal';	// open modal dialog for BIOS selection
	
	audio= new Audio(songs);
	gfx= new Graphix(audio);


	document.getElementById("previous").onclick = audio.playPreviousSong.bind(audio);
	document.getElementById("next").onclick = audio.playNextSong.bind(audio);
			
	document.getElementById("play").onclick = function(e){
		player.isPaused= false;
	};
	document.getElementById("pause").onclick = function(e){
		player.isPaused= true;
	};
	document.getElementById("gain").onchange = function(e){
		audio.gainNode.gain.value= this.value/255;
	};
	audio.playNextSong();
}

</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60370798-1', 'auto');
  ga('send', 'pageview');
</script>


	<style>
	.modalDialog {
		position: fixed;
		font-family: Arial, Helvetica, sans-serif;
		top: 0;
		right: 0;
		bottom: 0;
		left: 0;
		background: rgba(0,0,0,0.8);
		z-index: 99999;
		opacity:0;
		-webkit-transition: opacity 400ms ease-in;
		-moz-transition: opacity 400ms ease-in;
		transition: opacity 400ms ease-in;
		pointer-events: none;
	}

	.modalDialog:target {
		opacity:1;
		pointer-events: auto;
	}
	
	.modalDialog > div {
		width: 400px;
		position: relative;
		margin: 10% auto;
		padding: 5px 20px 13px 20px;
		border-radius: 10px;
		background: #fff;
		background: -moz-linear-gradient(#fff, #999);
		background: -webkit-linear-gradient(#fff, #999);
		background: -o-linear-gradient(#fff, #999);
	}
	</style>
</head>

<body onload="init();">

<div id="openModal" class="modalDialog">
	<div>
		<h2>PlayStation2 setup</h2>
		<p>This emulator requires an original PlayStation2 BIOS image. Due to copyright concerns the BIOS is not bundled with the player installed on this web page. </p>
		<p> Upload your respective BIOS image by drag&amp;dropping it on the below BIOS chip (you can also use a .gz compressed BIOS image). In case you have misplaced your PS2 console don't dispair.. Google will surely help..</p>
		<p></p>
		  <div id="dropbios" class="dropbios" ondrop="dropbios(event)" ondragover="allowDrop(event)">
			<img src="BIOS.gif"/>
		</div>
  
	</div>
</div>
<div class="tooltip" id="tooltip" alt="This is a hobby project, but it costs not only time to regularily maintain this site but also money to pay for the internet service provider (etc). If you want to keep this site up and running.. or if you just like my work (see https://jwothke.wordpress.com/) and you'd like to see more of it in the future, please make a contribution. Thank you!">
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="E7ACAHA7W5FYC">
<input type="image" src="btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="pixel.gif" width="1" height="1">
</form>
</div>

<details>
  <summary>What's this?</summary>
  <div>
 <p>
    webPSX: Experimental JavaScript/HTML5 version of <a href="https://github.com/kode54/deadbeef_he/" target="_blank">Highly Experimental</a>. It plays Playstation 1 & 2 music(respective files can be found <a target="_blank" href="http://www.vgmusic.com/music/console/sony/ps1/">here</a> or <a target="_blank" href="http://www.zophar.net/music/psf.html">there</a>.).
 </p>
 <p>
	Bring your own music files by dropping them onto the below PlayStation. (In order to play a .minipsf file you first need to drop the .psflib file that that it depends on.)
 </p>
 
  <p>2015 by Juergen Wothke  (The source code can be found <a target="_blank" href="https://github.com/wothke/">here</a>.)</p>
 
  <p>This page does not use any plugins but is based exclusively on the draft version Web Audio API. 
  You'll need Chrome or Firefox to make it play the music. The visual effects 
  work best in Chrome. (If Firefox passes out - press 'reload'... it's experimental.)

  <p>Please use the below controls to navigate between the songs that you have dropped on the player: 
<button id="play"> &gt;</button>
<button id="pause"> ||</button>
<button id="previous"> |&lt;&lt;</button>
<button id="next"> &gt;&gt;|</button>
<input type="range" id="gain" name="gain" min="1" max="255" value="255">

 </div>
</details>
<aside>
  
</aside>

<section>
  <div id="logo" class="logo">
	<div id="moz-reflect-logo"><canvas  id="logoCanvas"  width="600" height="250"></canvas></div>
  </div>
  <div id="spectrum" class="spectrum">
  	<div id="moz-reflect-spectrum"><canvas id="spectrumCanvas" width="512" height="200"></canvas></div>
  </div>
  <div id="drop" class="drop" ondrop="drop(event)" ondragover="allowDrop(event)">
 <img src="psx.gif" width=270 height=270/>
  </div>

</section>

</body>
</html>
